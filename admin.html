<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ProSell - Табло заказов</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #0b0c10; color: #e8e8e8; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 20px; }
    .card { background: #141621; border: 1px solid rgba(255,255,255,0.06); border-radius: 14px; padding: 16px; margin-bottom: 14px; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    input { width: 420px; max-width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); background: #0e1020; color: #fff; }
    button { padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.12); background: #1b1f33; color: #fff; cursor: pointer; }
    button:hover { background: #222747; }
    .muted { color: rgba(255,255,255,0.65); font-size: 13px; }
    .ok { color: #7CFF9B; font-weight: 700; }
    .bad { color: #ff6b6b; font-weight: 700; }
    .order { border-left: 4px solid #3b82f6; }
    .h { font-size: 18px; font-weight: 800; margin: 0 0 6px 0; }
    .grid { display: grid; gap: 10px; }
    .kv { display: grid; grid-template-columns: 130px 1fr; gap: 6px 12px; font-size: 14px; }
    .kv div:nth-child(odd) { color: rgba(255,255,255,0.6); }
    pre { white-space: pre-wrap; background: #0e1020; padding: 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.08); }
    .top { display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
    .pill { padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,0.07); font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <div class="h">Табло заказов</div>
          <div class="muted">Доступ только по секретному коду (token). Без кода будет "unauthorized".</div>
        </div>
        <div class="pill" id="statusPill">ok: 0</div>
      </div>

      <div style="height:12px"></div>

      <div class="row">
        <input id="tokenInput" placeholder="Вставь сюда свой token" />
        <button id="saveBtn">Сохранить</button>
        <button id="refreshBtn">Обновить</button>
      </div>

      <div style="height:10px"></div>
      <div class="muted">
        Подсказка: token - это то, что ты сам задаешь в Apps Script (ADMIN_TOKEN). Он не появляется сам.
      </div>
    </div>

    <div class="card">
      <div class="h">Заказы</div>
      <div class="muted" id="hint">Пока пусто. Либо нет заказов, либо неверный token, либо Apps Script не обновлен (Deploy).</div>
      <div style="height:12px"></div>
      <div class="grid" id="ordersList"></div>
    </div>
  </div>

  <script src="api.js"></script>
  <script>
    const LS_KEY = "ps_admin_token";

    const tokenInput = document.getElementById("tokenInput");
    const saveBtn = document.getElementById("saveBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const ordersList = document.getElementById("ordersList");
    const statusPill = document.getElementById("statusPill");
    const hint = document.getElementById("hint");

    function setStatus(ok, text) {
      statusPill.textContent = text;
      statusPill.className = "pill " + (ok ? "ok" : "bad");
    }

    function esc(s) {
      return String(s || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;");
    }

    function fmtIso(ts) {
      try {
        const d = new Date(ts);
        return d.toLocaleString("ru-RU");
      } catch (e) { return ts || ""; }
    }

    function renderOrders(list) {
      ordersList.innerHTML = "";
      if (!list.length) {
        hint.textContent = "Пока пусто. Либо нет заказов, либо неверный token.";
        return;
      }
      hint.textContent = "Найдено заказов: " + list.length;

      list.forEach(o => {
        const div = document.createElement("div");
        div.className = "card order";

        const itemsText = Array.isArray(o.items) ? o.items.map(it => {
          const name = it.name || it.sku || it.id || "item";
          const qty = it.qty || 1;
          const price = it.price || 0;
          return name + " x" + qty + " = " + (price * qty);
        }).join("\\n") : "";

        div.innerHTML = `
          <div class="h">${esc(o.order_id || "ORD")}</div>
          <div class="kv">
            <div>Время</div><div>${esc(fmtIso(o.ts))}</div>
            <div>Имя</div><div>${esc(o.name || "")}</div>
            <div>Телефон</div><div>${esc(o.phone || "")}</div>
            <div>Город</div><div>${esc(o.city || "")}</div>
            <div>Сумма</div><div>${esc(o.total || 0)}</div>
          </div>
          ${o.comment ? `<div style="height:8px"></div><div class="muted">Комментарий:</div><pre>${esc(o.comment)}</pre>` : ""}
          <div style="height:8px"></div>
          <div class="muted">Товары:</div>
          <pre>${esc(itemsText || "(нет items)")}</pre>
        `;

        ordersList.appendChild(div);
      });
    }

    async function load() {
      const token = tokenInput.value.trim();
      if (!token) {
        setStatus(false, "ok: 0");
        renderOrders([]);
        return;
      }

      setStatus(true, "loading...");
      try {
        const res = await API.adminGetOrders(token);

        if (!res || res.ok !== true) {
          const err = (res && res.error) ? res.error : "unknown";
          setStatus(false, "unauthorized");
          hint.textContent = "Ошибка: " + err + ". Проверь token и что Apps Script обновлен через Deploy.";
          renderOrders([]);
          return;
        }

        setStatus(true, "ok: 1");
        renderOrders(res.orders || []);
      } catch (e) {
        setStatus(false, "error");
        hint.textContent = "Сеть/ошибка запроса. Открой DevTools -> Network и посмотри запрос к /exec.";
        renderOrders([]);
      }
    }

    saveBtn.addEventListener("click", () => {
      localStorage.setItem(LS_KEY, tokenInput.value.trim());
      load();
    });

    refreshBtn.addEventListener("click", load);

    // init
    const saved = localStorage.getItem(LS_KEY) || "";
    tokenInput.value = saved;
    load();
  </script>
</body>
</html>
