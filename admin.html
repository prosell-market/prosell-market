<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ProSell Admin</title>
  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --primary:#2563eb;
      --border:#e5e7eb;
      --success:#10b981;
      --danger:#ef4444;
      --radius:12px;
      --shadow:0 1px 3px rgba(0,0,0,.1),0 1px 2px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);font-size:14px;line-height:1.5}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    .header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:16px}
    .logo{font-size:18px;font-weight:900}
    .logo b{color:var(--primary)}
    .auth{display:flex;gap:10px;align-items:center;margin-left:auto}
    .status{font-size:12px;font-weight:700;color:var(--muted)}
    .token{padding:8px 12px;border:1px solid var(--border);border-radius:10px;width:220px}
    .btn{padding:8px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:12px 0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .stat{padding:14px}
    .stat .l{font-size:12px;color:var(--muted);font-weight:700}
    .stat .v{font-size:24px;font-weight:900;margin-top:2px}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:12px}
    .search{flex:1;min-width:240px;padding:10px 12px;border:1px solid var(--border);border-radius:10px}
    .toggle{display:flex;align-items:center;gap:8px;font-size:12px;font-weight:800;color:var(--muted);cursor:pointer;user-select:none}
    .sw{width:38px;height:22px;background:#e5e7eb;border-radius:999px;position:relative}
    .sw:after{content:"";position:absolute;top:3px;left:3px;width:16px;height:16px;background:#fff;border-radius:50%;box-shadow:0 1px 2px rgba(0,0,0,.2);transition:.2s}
    .toggle.on .sw{background:var(--success)}
    .toggle.on .sw:after{transform:translateX(16px)}
    .list{display:grid;gap:14px}
    .order{overflow:hidden}
    .oh{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;padding:14px;background:#f9fafb;border-bottom:1px solid var(--border)}
    .oid{font-weight:900;font-size:16px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .badge{font-size:11px;font-weight:900;padding:3px 10px;border-radius:999px;border:1px solid var(--border);background:#fff}
    .b-new{background:#dbeafe;border-color:#bfdbfe;color:#1e40af}
    .b-work{background:#fff7ed;border-color:#fed7aa;color:#9a3412}
    .b-asm{background:#ecfccb;border-color:#bef264;color:#3f6212}
    .b-ship{background:#e0e7ff;border-color:#c7d2fe;color:#3730a3}
    .b-done{background:#dcfce7;border-color:#bbf7d0;color:#166534}
    .b-arch{background:#f3f4f6;border-color:#e5e7eb;color:#374151}
    .time{font-size:12px;color:var(--muted);text-align:right}
    .time b{display:block;color:var(--text)}
    .ob{padding:14px;display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:720px){.ob{grid-template-columns:1fr}}
    .lab{font-size:11px;color:var(--muted);font-weight:900;letter-spacing:.3px;text-transform:uppercase}
    .val{font-size:14px;font-weight:800;word-break:break-word}
    .items{margin-top:8px;background:var(--bg);border-radius:10px;padding:10px}
    .it{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed #d1d5db;font-size:13px}
    .it:last-child{border-bottom:none}
    .of{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:12px 14px;border-top:1px solid var(--border);flex-wrap:wrap}
    .total{font-size:18px;font-weight:900}
    .act{display:flex;gap:8px;flex-wrap:wrap}
    .msg{padding:40px;text-align:center;color:var(--muted);font-weight:800}
    .smallbtn{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:900;font-size:12px}
    .smallbtn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .smallbtn.danger{background:#fff1f2;border-color:#fecdd3;color:#9f1239}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="logo"><b>PRO</b>SELL Admin</div>
      <div class="auth">
        <div id="status" class="status">Не подключено</div>
        <input id="token" class="token" type="password" placeholder="Admin token" />
        <button id="login" class="btn primary">Войти</button>
      </div>
    </div>

    <div class="grid">
      <div class="card stat">
        <div class="l">Всего заказов</div>
        <div class="v" id="stTotal">0</div>
      </div>
      <div class="card stat">
        <div class="l">Новых (status=new)</div>
        <div class="v" id="stNew">0</div>
      </div>
      <div class="card stat">
        <div class="l">Сумма сегодня</div>
        <div class="v" id="stSum">0</div>
      </div>
    </div>

    <div class="card bar">
      <input id="search" class="search" placeholder="Поиск (ID, имя, телефон, город)..." />
      <button id="refresh" class="btn">Обновить</button>

      <div id="tAuto" class="toggle">
        <div>Авто (30с)</div><div class="sw"></div>
      </div>

      <div id="tArch" class="toggle">
        <div>Показать архив</div><div class="sw"></div>
      </div>
    </div>

    <div id="list" class="list">
      <div class="msg">Введите токен и нажмите "Войти".</div>
    </div>
  </div>

  <script src="api.js"></script>
  <script>
    const LS_TOKEN = "ps_admin_token";
    const AUTO_MS = 30000;

    const STATUS_LABEL = {
      new: "Новый",
      in_work: "В работе",
      assembled: "Собран",
      shipped: "Отправлен",
      done: "Закрыт",
      archived: "Архив"
    };

    const STATUS_BADGE = {
      new: "b-new",
      in_work: "b-work",
      assembled: "b-asm",
      shipped: "b-ship",
      done: "b-done",
      archived: "b-arch"
    };

    const el = {
      token: document.getElementById("token"),
      login: document.getElementById("login"),
      refresh: document.getElementById("refresh"),
      status: document.getElementById("status"),
      search: document.getElementById("search"),
      list: document.getElementById("list"),
      stTotal: document.getElementById("stTotal"),
      stNew: document.getElementById("stNew"),
      stSum: document.getElementById("stSum"),
      tAuto: document.getElementById("tAuto"),
      tArch: document.getElementById("tArch"),
    };

    const state = {
      orders: [],
      q: "",
      auto: false,
      showArchived: false,
      timer: null
    };

    function fmtMoney(n){
      return new Intl.NumberFormat("ru-RU",{style:"currency",currency:"RUB",maximumFractionDigits:0}).format(n||0);
    }

    function fmtTime(ts){
      const d = new Date(ts);
      const now = new Date();
      const diffMin = Math.round((now - d) / 60000);
      let rel = "";
      if (diffMin < 1) rel = "Только что";
      else if (diffMin < 60) rel = diffMin + " мин. назад";
      else if (diffMin < 1440) rel = Math.round(diffMin/60) + " ч. назад";
      else rel = Math.round(diffMin/1440) + " дн. назад";

      const exact = d.toLocaleString("ru-RU",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"});
      const isToday = now.toDateString() === d.toDateString();
      return { rel, exact, isToday };
    }

    function esc(s){
      return String(s||"")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;");
    }

    function setStatus(ok, text){
      el.status.textContent = text;
      el.status.style.color = ok ? "var(--success)" : "var(--danger)";
    }

    async function load(){
      const token = el.token.value.trim();
      if (!token) { setStatus(false,"Нет токена"); return; }

      setStatus(true,"Загрузка...");
      el.refresh.disabled = true;

      try{
        const res = await API.adminGetOrders(token, state.showArchived);
        if (!res || !res.ok){
          setStatus(false,"Ошибка");
          el.list.innerHTML = '<div class="msg">Ошибка: ' + esc(res && res.error ? res.error : "unknown") + "</div>";
          return;
        }

        state.orders = (res.orders || []).map(o => ({
          ...o,
          status: (o.status || "new").trim() || "new"
        }));

        updateStats();
        render();
        setStatus(true,"OK");
      }catch(e){
        console.error(e);
        setStatus(false,"Сеть");
        el.list.innerHTML = '<div class="msg">Ошибка сети. Открой консоль.</div>';
      }finally{
        el.refresh.disabled = false;
      }
    }

    function updateStats(){
      const total = state.orders.length;
      const cntNew = state.orders.filter(o => o.status === "new").length;

      const todaySum = state.orders.reduce((acc,o)=>{
        const t = fmtTime(o.ts);
        if (!t.isToday) return acc;
        return acc + (parseFloat(o.total)||0);
      },0);

      el.stTotal.textContent = total;
      el.stNew.textContent = cntNew;
      el.stSum.textContent = fmtMoney(todaySum);
    }

    function render(){
      const q = state.q.toLowerCase();
      const list = state.orders.filter(o=>{
        const text = (o.order_id + " " + o.name + " " + o.phone + " " + o.city).toLowerCase();
        return text.includes(q);
      });

      if (!list.length){
        el.list.innerHTML = '<div class="msg">Ничего не найдено</div>';
        return;
      }

      el.list.innerHTML = list.map(o=>{
        const t = fmtTime(o.ts);
        const total = parseFloat(o.total)||0;

        const statusLabel = STATUS_LABEL[o.status] || o.status;
        const badgeClass = STATUS_BADGE[o.status] || "b-new";

        const items = Array.isArray(o.items) ? o.items : [];
        const itemsHtml = items.length ? items.map(it=>{
          const name = it.name || it.sku || "Товар";
          const qty = it.qty || 1;
          const price = it.price || 0;
          const sum = qty * price;
          return '<div class="it"><div><b>' + esc(name) + '</b></div><div>' + qty + " x " + price + " = <b>" + sum + "</b></div></div>";
        }).join("") : '<div class="it" style="color:#9ca3af">Нет товаров</div>';

        const copyText =
`Заказ: ${o.order_id}
Статус: ${statusLabel}
Имя: ${o.name || ""}
Тел: ${o.phone || ""}
Город/адрес: ${o.city || ""}
Сумма: ${total}
Комментарий: ${o.comment || ""}
Товары:
${items.map(it => "- " + (it.name || it.sku || "Товар") + " x" + (it.qty || 1)).join("\n")}
`;

        // Buttons are disabled for archived to avoid mistakes (but you can still change if you want)
        const disabled = (o.status === "archived") ? "disabled" : "";

        return `
          <div class="card order">
            <div class="oh">
              <div class="oid">
                #${esc(o.order_id)}
                <span class="badge ${badgeClass}">${esc(statusLabel)}</span>
              </div>
              <div class="time">
                <b>${esc(t.rel)}</b>
                ${esc(t.exact)}
              </div>
            </div>

            <div class="ob">
              <div>
                <div class="lab">Клиент</div>
                <div class="val">${esc(o.name || "Не указано")}</div>

                <div style="height:8px"></div>
                <div class="lab">Телефон</div>
                <div class="val" style="color:var(--primary)">${esc(o.phone || "-")}</div>

                <div style="height:8px"></div>
                <div class="lab">Город / адрес</div>
                <div class="val">${esc(o.city || "-")}</div>

                ${o.comment ? `
                  <div style="height:8px"></div>
                  <div class="lab">Комментарий</div>
                  <div class="val" style="background:#fffbe6;padding:6px 10px;border-radius:10px;border:1px solid #fde68a">${esc(o.comment)}</div>
                ` : ""}
              </div>

              <div>
                <div class="lab">Состав заказа</div>
                <div class="items">${itemsHtml}</div>

                <div style="height:10px"></div>
                <div class="lab">Действия со статусом</div>
                <div class="act" style="margin-top:6px">
                  <button class="smallbtn" ${disabled} onclick="setOrderStatus('${esc(o.order_id)}','in_work')">В работу</button>
                  <button class="smallbtn" ${disabled} onclick="setOrderStatus('${esc(o.order_id)}','assembled')">Собран</button>
                  <button class="smallbtn" ${disabled} onclick="setOrderStatus('${esc(o.order_id)}','shipped')">Отправлен</button>
                  <button class="smallbtn" ${disabled} onclick="setOrderStatus('${esc(o.order_id)}','done')">Закрыть</button>
                  <button class="smallbtn danger" onclick="setOrderStatus('${esc(o.order_id)}','archived')">Архив</button>
                </div>
              </div>
            </div>

            <div class="of">
              <div class="total">${fmtMoney(total)}</div>
              <div class="act">
                <button class="btn" onclick='copyText(${JSON.stringify(copyText)})'>Копировать</button>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    window.copyText = async function(text){
      try{
        await navigator.clipboard.writeText(text);
      }catch(e){
        alert("Не смог скопировать. Разреши доступ к буферу обмена.");
      }
    }

    window.setOrderStatus = async function(orderId, status){
      const token = el.token.value.trim();
      if (!token) return;

      try{
        const res = await API.adminSetOrderStatus(token, orderId, status);
        if (!res || !res.ok){
          alert("Ошибка: " + (res && res.error ? res.error : "unknown"));
          return;
        }
        await load();
      }catch(e){
        console.error(e);
        alert("Ошибка сети");
      }
    }

    el.login.addEventListener("click", ()=>{
      localStorage.setItem(LS_TOKEN, el.token.value.trim());
      load();
    });

    el.refresh.addEventListener("click", load);

    el.search.addEventListener("input", (e)=>{
      state.q = e.target.value;
      render();
    });

    el.tAuto.addEventListener("click", ()=>{
      state.auto = !state.auto;
      el.tAuto.classList.toggle("on", state.auto);

      if (state.auto){
        if (!state.timer) state.timer = setInterval(load, AUTO_MS);
      } else {
        if (state.timer){ clearInterval(state.timer); state.timer = null; }
      }
    });

    el.tArch.addEventListener("click", ()=>{
      state.showArchived = !state.showArchived;
      el.tArch.classList.toggle("on", state.showArchived);
      load();
    });

    // init
    const saved = localStorage.getItem(LS_TOKEN);
    if (saved){
      el.token.value = saved;
      load();
    }
  </script>
</body>
</html>
