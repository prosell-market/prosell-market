<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ProSell Control</title>
  <style>
    :root {
      --bg: #f8f9fa; --surface: #ffffff;
      --primary: #2563eb; --primary-dark: #1e40af;
      --text: #1f2937; --text-muted: #6b7280;
      --border: #e5e7eb;
      --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
      --radius: 12px;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); padding-bottom: 40px; }
    
    .wrap { max-width: 800px; margin: 0 auto; padding: 16px; }
    
    /* Header */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .logo { font-size: 20px; font-weight: 800; color: var(--text); }
    .logo span { color: var(--primary); }
    .auth-box { display: flex; gap: 8px; }
    .input-token { padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; width: 140px; font-size: 13px; }
    .btn { border: none; padding: 8px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 13px; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-dark); }
    
    /* Stats */
    .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
    .stat-card { background: var(--surface); padding: 12px; border-radius: var(--radius); border: 1px solid var(--border); text-align: center; }
    .stat-val { font-size: 20px; font-weight: 800; display: block; }
    .stat-lbl { font-size: 11px; color: var(--text-muted); text-transform: uppercase; font-weight: 600; }

    /* Tabs */
    .tabs { display: flex; gap: 4px; background: #e5e7eb; padding: 4px; border-radius: 10px; margin-bottom: 16px; }
    .tab { flex: 1; text-align: center; padding: 10px; font-size: 14px; font-weight: 600; cursor: pointer; border-radius: 8px; color: var(--text-muted); transition: 0.2s; }
    .tab.active { background: var(--surface); color: var(--text); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

    /* List */
    .search-bar { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 16px; font-size: 14px; }
    .order-list { display: flex; flex-direction: column; gap: 12px; }

    /* Order Card */
    .card { background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    .card-head { padding: 12px 16px; background: #f9fafb; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .card-id { font-weight: 700; font-size: 15px; }
    .card-time { font-size: 12px; color: var(--text-muted); }
    
    .card-body { padding: 16px; }
    .info-row { margin-bottom: 8px; font-size: 14px; }
    .info-row i { color: var(--text-muted); width: 20px; display: inline-block; text-align: center; margin-right: 6px; }
    .info-hl { color: var(--primary); font-weight: 500; }
    
    .items-box { background: #f3f4f6; border-radius: 8px; padding: 10px; margin: 10px 0; font-size: 13px; }
    .item-line { display: flex; justify-content: space-between; border-bottom: 1px dashed #d1d5db; padding-bottom: 4px; margin-bottom: 4px; }
    .item-line:last-child { border: none; margin: 0; padding: 0; }

    .card-foot { padding: 12px 16px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; }
    .total { font-size: 18px; font-weight: 800; }
    
    .actions { display: flex; gap: 8px; }
    .btn-act { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: #fff; cursor: pointer; font-size: 12px; font-weight: 600; }
    .btn-act:hover { background: #f3f4f6; }
    .btn-green { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
    .btn-green:hover { background: #bbf7d0; }
    .btn-red { background: #fee2e2; color: #991b1b; border-color: #fecaca; }

    .badge { padding: 2px 8px; border-radius: 99px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
    .bg-new { background: #dbeafe; color: #1e40af; }
    .bg-work { background: #ffedd5; color: #9a3412; }
    .bg-done { background: #d1fae5; color: #065f46; }

    .empty-state { text-align: center; padding: 40px; color: var(--text-muted); }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
</head>
<body>

<div class="wrap">
  <div class="header">
    <div class="logo"><span>Pro</span>Sell Admin</div>
    <div class="auth-box">
      <input id="token" type="password" class="input-token" placeholder="Token" />
      <button id="btn-login" class="btn btn-primary">Go</button>
      <button id="btn-refresh" class="btn"><i class="fa-solid fa-rotate"></i></button>
    </div>
  </div>

  <div class="stats">
    <div class="stat-card">
      <span class="stat-val" id="stat-new">0</span>
      <span class="stat-lbl">–ù–æ–≤—ã—Ö</span>
    </div>
    <div class="stat-card">
      <span class="stat-val" id="stat-work">0</span>
      <span class="stat-lbl">–í —Ä–∞–±–æ—Ç–µ</span>
    </div>
    <div class="stat-card">
      <span class="stat-val" id="stat-sum">0 ‚ÇΩ</span>
      <span class="stat-lbl">–°–µ–≥–æ–¥–Ω—è</span>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="new">–í—Ö–æ–¥—è—â–∏–µ</div>
    <div class="tab" data-tab="work">–í —Ä–∞–±–æ—Ç–µ</div>
    <div class="tab" data-tab="done">–ò—Å—Ç–æ—Ä–∏—è</div>
  </div>

  <input id="search" class="search-bar" placeholder="–ü–æ–∏—Å–∫ (–ò–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, ID)..." />

  <div id="order-list" class="order-list">
    </div>
</div>

<script src="api.js"></script>
<script>
  // --- CONFIG ---
  const LS_KEY = "ps_admin_tok_v4";
  let ALL_ORDERS = [];
  let CUR_TAB = "new";

  const el = {
    token: document.getElementById("token"),
    list: document.getElementById("order-list"),
    stats: { new: document.getElementById("stat-new"), work: document.getElementById("stat-work"), sum: document.getElementById("stat-sum") },
    tabs: document.querySelectorAll(".tab")
  };

  // --- HELPERS ---
  const fmtMoney = (n) => new Intl.NumberFormat("ru-RU", {style:"currency",currency:"RUB",maximumFractionDigits:0}).format(n||0);
  const formatDate = (ts) => {
    try {
      const d = new Date(ts);
      return d.toLocaleString("ru-RU", {month:"short", day:"numeric", hour:"2-digit", minute:"2-digit"});
    } catch(e) { return ts; }
  };
  const esc = (s) => String(s||"").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

  // --- LOGIC ---
  async function loadOrders() {
    const token = el.token.value.trim();
    if(!token) return alert("–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω");
    
    const btn = document.getElementById("btn-refresh");
    btn.innerHTML = "...";
    
    try {
      const res = await API.adminGetOrders(token);
      if(res && res.ok) {
        ALL_ORDERS = res.orders || [];
        updateStats();
        render();
      } else {
        el.list.innerHTML = `<div class="empty-state">–û—à–∏–±–∫–∞: ${res?.error || "Unknown"}</div>`;
      }
    } catch(e) {
      el.list.innerHTML = `<div class="empty-state">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</div>`;
    } finally {
      btn.innerHTML = `<i class="fa-solid fa-rotate"></i>`;
    }
  }

  function updateStats() {
    const newCnt = ALL_ORDERS.filter(o => o.status === "new").length;
    const workCnt = ALL_ORDERS.filter(o => ["in_work","assembled","shipped"].includes(o.status)).length;
    
    const today = new Date().toDateString();
    const sum = ALL_ORDERS.reduce((acc, o) => {
      if(new Date(o.ts).toDateString() === today) return acc + (Number(o.total)||0);
      return acc;
    }, 0);

    el.stats.new.textContent = newCnt;
    el.stats.work.textContent = workCnt;
    el.stats.sum.textContent = fmtMoney(sum);
  }

  function render() {
    const q = document.getElementById("search").value.toLowerCase();
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–∞–±–∞–º
    let visibleOrders = ALL_ORDERS.filter(o => {
      const s = o.status;
      if (CUR_TAB === "new") return s === "new";
      if (CUR_TAB === "work") return ["in_work", "assembled", "shipped"].includes(s);
      if (CUR_TAB === "done") return ["done", "archived", "canceled"].includes(s);
      return false;
    });

    // –ü–æ–∏—Å–∫
    if(q) {
      visibleOrders = visibleOrders.filter(o => 
        (o.order_id + o.name + o.phone + o.city).toLowerCase().includes(q)
      );
    }

    if(visibleOrders.length === 0) {
      el.list.innerHTML = `<div class="empty-state">–í —ç—Ç–æ–º —Ä–∞–∑–¥–µ–ª–µ –ø—É—Å—Ç–æ üò¥</div>`;
      return;
    }

    el.list.innerHTML = visibleOrders.map(o => {
      const items = o.items || [];
      const itemsHtml = items.map(i => `
        <div class="item-line">
          <span>${esc(i.name || i.sku)} x${i.qty}</span>
          <b>${(i.price * i.qty)}</b>
        </div>
      `).join("");

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–∫–ª–∞–¥–∫–∏
      let actionsHtml = "";
      
      if(CUR_TAB === "new") {
        actionsHtml = `<button class="btn-act btn-green" onclick="setStatus('${o.order_id}', 'in_work')">–ü—Ä–∏–Ω—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>`;
      } 
      else if (CUR_TAB === "work") {
        actionsHtml = `
          <button class="btn-act" onclick="setStatus('${o.order_id}', 'assembled')">–°–æ–±—Ä–∞–Ω</button>
          <button class="btn-act" onclick="setStatus('${o.order_id}', 'shipped')">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</button>
          <button class="btn-act btn-green" onclick="setStatus('${o.order_id}', 'done')">–í—ã–ø–æ–ª–Ω–µ–Ω</button>
          <button class="btn-act btn-red" onclick="setStatus('${o.order_id}', 'canceled')">–û—Ç–º–µ–Ω–∞</button>
        `;
      }
      else {
        actionsHtml = `<button class="btn-act" onclick="setStatus('${o.order_id}', 'in_work')">–í–µ—Ä–Ω—É—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>`;
      }

      // –ï—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ "–í —Ä–∞–±–æ—Ç–µ" –∏–ª–∏ "–ò—Å—Ç–æ—Ä–∏—è", –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ê—Ä—Ö–∏–≤–∞ (—Ç–∏—Ö–æ–µ —Å–∫—Ä—ã—Ç–∏–µ)
      if ((CUR_TAB === "work" || CUR_TAB === "done") && o.status !== 'archived') {
         actionsHtml += `<button class="btn-act" style="margin-left:auto" title="–°–∫—Ä—ã—Ç—å –≤ –∞—Ä—Ö–∏–≤ (–±–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)" onclick="setStatus('${o.order_id}', 'archived')"><i class="fa-solid fa-box-archive"></i></button>`;
      }
      
      const badgeMap = {
        'new': '<span class="badge bg-new">–ù–æ–≤—ã–π</span>',
        'in_work': '<span class="badge bg-work">–í —Ä–∞–±–æ—Ç–µ</span>',
        'assembled': '<span class="badge bg-work">–°–æ–±—Ä–∞–Ω</span>',
        'shipped': '<span class="badge bg-work">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</span>',
        'done': '<span class="badge bg-done">–ì–æ—Ç–æ–≤</span>',
        'archived': '<span class="badge">–ê—Ä—Ö–∏–≤</span>',
        'canceled': '<span class="badge btn-red">–û—Ç–º–µ–Ω–∞</span>'
      };

      return `
        <div class="card">
          <div class="card-head">
            <span class="card-id">#${esc(o.order_id)} ${badgeMap[o.status]||""}</span>
            <span class="card-time">${formatDate(o.ts)}</span>
          </div>
          <div class="card-body">
            <div class="info-row"><i class="fa-regular fa-user"></i> <b>${esc(o.name)}</b></div>
            <div class="info-row"><i class="fa-solid fa-phone"></i> <a href="tel:${esc(o.phone)}" class="info-hl">${esc(o.phone)}</a></div>
            <div class="info-row"><i class="fa-solid fa-location-dot"></i> ${esc(o.city)}</div>
            ${o.comment ? `<div class="info-row" style="background:#fffbe6;padding:5px;border-radius:4px;font-size:12px">üí¨ ${esc(o.comment)}</div>` : ""}
            
            <div class="items-box">${itemsHtml}</div>
          </div>
          <div class="card-foot">
            <div class="total">${fmtMoney(o.total)}</div>
            <div class="actions">${actionsHtml}</div>
          </div>
        </div>
      `;
    }).join("");
  }

  window.setStatus = async (id, st) => {
    // –í –∞—Ä—Ö–∏–≤ —É–±–∏—Ä–∞–µ–º —Ç–∏—Ö–æ, –æ—Å—Ç–∞–ª—å–Ω—ã–µ - —Å–ø—Ä–∞—à–∏–≤–∞–µ–º
    if(st !== 'archived' && !confirm(`–°–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞? –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.`)) return;
    try {
      await API.adminUpdateOrderStatus(el.token.value, id, st);
      loadOrders(); 
    } catch(e) { alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
  }

  // --- EVENTS ---
  document.getElementById("btn-login").addEventListener("click", () => {
    localStorage.setItem(LS_KEY, el.token.value);
    loadOrders();
  });

  document.getElementById("btn-refresh").addEventListener("click", loadOrders);
  document.getElementById("search").addEventListener("input", render);

  el.tabs.forEach(t => t.addEventListener("click", () => {
    el.tabs.forEach(x => x.classList.remove("active"));
    t.classList.add("active");
    CUR_TAB = t.dataset.tab;
    render();
  }));

  // Init
  const saved = localStorage.getItem(LS_KEY);
  if(saved) { el.token.value = saved; loadOrders(); }
  setInterval(loadOrders, 30000); 
</script>
</body>
</html>